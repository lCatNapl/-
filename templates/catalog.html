catalog
{% extends "base.html" %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä - –£–∑–Ω–∞–≤–∞–π–∫–∏–Ω{% endblock %}

{% block content %}
<div class="catalog-header">
    <h2><i class="fas fa-gamepad"></i> –ö–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä ({{ games.total }})</h2>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters">
        <div class="filter-group">
            <select id="category-filter" class="filter-select">
                <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <option value="action">–≠–∫—à–µ–Ω</option>
                <option value="rpg">RPG</option>
                <option value="strategy">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</option>
                <option value="racing">–ì–æ–Ω–∫–∏</option>
                <option value="puzzle">–ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∏</option>
                <option value="multiplayer">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</option>
            </select>
            
            <select id="sort-filter" class="filter-select">
                <option value="rating-desc">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É ‚Üì</option>
                <option value="rating-asc">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É ‚Üë</option>
                <option value="newest">–ù–æ–≤–∏–Ω–∫–∏</option>
                <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
            </select>
        </div>
        
        <div class="filter-group">
            <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
            <button id="clear-filters" class="btn btn-outline">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –°—á–µ—Ç—á–∏–∫–∏ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="catalog-stats">
    <span>–ü–æ–∫–∞–∑–∞–Ω—ã –∏–≥—Ä—ã {{ games.start - games.per_page + 1 }}‚Äì{{ games.start }} –∏–∑ {{ games.total }}</span>
    {% if games.has_prev %}
        <a href="{{ url_for('catalog', page=games.prev_num, category=request.args.get('category', 'all')) }}" class="page-link">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–µ</a>
    {% endif %}
    
    {% if games.has_next %}
        <a href="{{ url_for('catalog', page=games.next_num, category=request.args.get('category', 'all')) }}" class="page-link">–°–ª–µ–¥—É—é—â–∏–µ ‚Üí</a>
    {% endif %}
</div>

<!-- –°–µ—Ç–∫–∞ –∏–≥—Ä -->
<div class="games-grid" id="games-grid">
    {% for game in games.items %}
    <div class="game-card" data-game-id="{{ game.id }}" data-category="{{ game.category }}" data-rating="{{ game.rating }}" data-title="{{ game.title|lower }}">
        <div class="game-image">
            {% if current_user.is_authenticated and current_user.subscription_type == 'premium' and game.image_premium_3d %}
                <div class="premium-3d-badge">3D</div>
                <div class="game-3d-placeholder">
                    <i class="fas fa-cube"></i>
                    <span>Premium 3D</span>
                </div>
            {% elif current_user.is_authenticated and current_user.subscription_type in ['vip', 'premium'] and game.image_vip %}
                <div class="vip-image-badge">VIP</div>
                <img src="{{ game.image_vip }}" alt="{{ game.title }}" loading="lazy">
            {% else %}
                <img src="{{ game.image_start or '/static/images/default-game.jpg' }}" alt="{{ game.title }}" loading="lazy">
            {% endif %}
            
            {% if game.is_featured %}
                <div class="featured-badge">‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º</div>
            {% endif %}
            
            {% if current_user.is_authenticated and current_user.subscription_type != 'start' %}
                <div class="subscription-exclusive">
                    {% if current_user.subscription_type == 'vip' or (current_user.subscription_type == 'premium' and game.image_vip) %}
                        <i class="fas fa-crown"></i>
                    {% elif current_user.subscription_type == 'premium' and game.image_premium_3d %}
                        <i class="fas fa-gem"></i>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <div class="game-info">
            <div class="game-header">
                <h4>{{ game.title }}</h4>
                <span class="category-badge category-{{ game.category }}">{{ game.category }}</span>
            </div>
            
            <div class="rating" style="--rating: {{ game.rating / 5 }}">
                ‚òÖ {{ "%.1f"|format(game.rating) }}/5
            </div>
            
            <p class="description">
                {% if current_user.is_authenticated %}
                    {{ game.get_description(current_user.subscription_type)|truncate(120) }}
                {% else %}
                    {{ game.get_description('start')|truncate(120) }}
                {% endif %}
            </p>
            
            <div class="game-actions">
                <a href="{{ url_for('game_detail', game_id=game.id) }}" class="btn btn-primary btn-small">
                    <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </a>
                {% if current_user.is_authenticated %}
                    <button class="btn-favorite" data-game-id="{{ game.id }}" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                        <i class="far fa-heart"></i>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-games">
        <i class="fas fa-gamepad"></i>
        <h3>–ò–≥—Ä –ø–æ–∫–∞ –Ω–µ—Ç</h3>
        <p>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∫–∞—Ç–∞–ª–æ–≥ –∫—Ä—É—Ç—ã—Ö –∏–≥—Ä!</p>
    </div>
    {% endfor %}
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
<div class="catalog-stats pagination-bottom">
    {% if games.has_prev %}
        <a href="{{ url_for('catalog', page=games.prev_num, category=request.args.get('category', 'all')) }}" class="page-link">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–µ</a>
    {% endif %}
    
    <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ games.page }} –∏–∑ {{ games.pages }}</span>
    
    {% if games.has_next %}
        <a href="{{ url_for('catalog', page=games.next_num, category=request.args.get('category', 'all')) }}" class="page-link">–°–ª–µ–¥—É—é—â–∏–µ ‚Üí</a>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div id="quick-view-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div id="modal-game-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('games-grid');
    let currentGames = Array.from(grid.children);

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    function applyFilters() {
        const category = document.getElementById('category-filter').value;
        const sort = document.getElementById('sort-filter').value;
        const search = document.getElementById('search-input').value.toLowerCase();

        let filteredGames = currentGames.filter(game => {
            const gameCategory = game.dataset.category;
            const gameTitle = game.dataset.title;
            
            return (!category || category === 'all' || gameCategory === category) &&
                   (!search || gameTitle.includes(search));
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filteredGames.sort((a, b) => {
            switch(sort) {
                case 'rating-desc':
                    return parseFloat(b.dataset.rating) - parseFloat(a.dataset.rating);
                case 'rating-asc':
                    return parseFloat(a.dataset.rating) - parseFloat(b.dataset.rating);
                case 'newest':
                    return b.dataset.createdAt - a.dataset.createdAt || 0;
                case 'title':
                    return a.dataset.title.localeCompare(b.dataset.title);
                default:
                    return 0;
            }
        });

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
        grid.innerHTML = '';
        filteredGames.forEach(game => grid.appendChild(game));
        
        updateStats();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('category-filter').addEventListener('change', applyFilters);
    document.getElementById('sort-filter').addEventListener('change', applyFilters);
    document.getElementById('search-input').addEventListener('input', applyFilters);

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('category-filter').value = 'all';
        document.getElementById('sort-filter').value = 'rating-desc';
        document.getElementById('search-input').value = '';
        applyFilters();
    });

    // –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ)
    document.querySelectorAll('.btn-favorite').forEach(btn => {
        btn.addEventListener('click', function() {
            const gameId = this.dataset.gameId;
            const icon = this.querySelector('i');
            
            if (icon.classList.contains('far')) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.style.color = '#E74C3C';
                this.title = '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ';
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                icon.style.color = '';
                this.title = '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
            }
        });
    });

    // –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä (–∑–∞–≥–ª—É—à–∫–∞)
    grid.addEventListener('click', function(e) {
        if (e.target.closest('.game-card')) {
            const gameCard = e.target.closest('.game-card');
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –∑–∞–≥—Ä—É–∑–∫—É –¥–µ—Ç–∞–ª–µ–π –∏–≥—Ä—ã
        }
    });

    function updateStats() {
        const visibleGames = document.querySelectorAll('#games-grid .game-card');
        console.log(`–ü–æ–∫–∞–∑–∞–Ω—ã ${visibleGames.length} –∏–≥—Ä`);
    }
});
</script>
{% endblock %}
